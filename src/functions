#!/usr/bin/env bash

################################################################################
############################### Global variables ###############################
################################################################################

_ip_list=()
_ip_amount=""
_ip=""
_port=""
_user=""
_pass=""
_iface=""
_hwaddr=""
_output_type=""
_output_path=""

_session_variables=(\
                      "_ip:IP address:ip" \
                      "_port:Service port number:port" \
                      "_user:Username:user" \
                      "_pass:User password:pass" \
                      "_iface:Network interface:iface" \
                      "_hwaddr:MAC address:hwaddr" \
                      "_domain:Domain name:domain" \
                      "_userdb:Database user name:userdb" \
                      "_passdb:Database user password:passdb" \
                      "_output_type:Output file type:outtype" \
                      "_output_path:Output file path:outpath")


################################################################################
######################## Definitions of user functions #########################
################################################################################

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _init_cli()
#
# Description:
#   Starting the Dracnmap command interpreter.
#
# Usage:
#   _init_cli
#
# Examples:
#   _init_cli
#

function _init_cli() {

  local _FUNCTION_ID="_init_cli"
  local _STATE=0

  input_array=()

  while [ "${input_array[0]}" != "exit" ] ; do

    cstate="1"

    __cli_banner="dracnmap-v2"

    printf "\e[1;31m%s\e[m " "${__cli_prompt}${__cli_banner}>" && read -ra input_array

    case ${input_array[0]} in

      01|1)

        $xterm $_ip

        cstate=1
        ;;

      02|2)

        echo -en $cyan""
        echo -en "How many addresses do you want to scan? " ; tput sgr0
        read -ra _ip_amount

        for i in $(seq 1 $_ip_amount) ; do

          _set_ip
          _ip_list+=("$_ip")

        done

        if [[ $? -eq 0 ]] ; then

          $xterm ${_ip_list[@]}

        fi

        cstate=1
        ;;

      03|3)

        $xterm -sV -T4 -O -F --version-light 1 $_ip

        cstate=1
        ;;

      04|4)

        $xterm -sA $_ip

        cstate=1
        ;;

      05|5)

        $xterm -sS -P0 $_ip

        cstate=1
        ;;

      06|6)

        menu_pingbebeb
        _init_cli_pingbebeb
        ;;

      07|7)

        menu_webservice
        _init_cli_webservice
        ;;

      08|8)

        menu_nse
        _init_cli_nse
        ;;

      09|9)

        menu_zenmapscript
        _init_cli_zenmapscript
        ;;

      10)

        menu_scanoutput
        _init_cli_scanoutput
        ;;

      11)

        credits
        cstate="0" ;;

      help)

        _help_
        cstate="0" ;;

      show)

        if [ ${input_array[1]} ] ; then

          case ${input_array[1]} in

            session)

              show_session
              ;;

            *)
              printf "stdout: %s\n" "unknown command" ;;

          esac

        else

          printf "stdout: %s\n" "unknown argument"

        fi
        cstate="0" ;;

      set)

        if [ ${input_array[1]} ] ; then

          case ${input_array[1]} in

            session)

              if [ ${input_array[2]} ] ; then

                set_session "${input_array[2]}"

              else

                printf "stdout: %s\n" "invalid session params"

              fi
              ;;

            *)
              printf "stdout: %s\n" "unknown command" ;;

          esac

        else

          printf "stdout: %s\n" "unknown argument"

        fi
        cstate="0" ;;

      clear|main)

        menu
        _init_cli
        cstate="0" ;;

      back)

        printf "stdout: %s\n" "you are in root level" ;;

      nmap)

        _init_cmd "nmap ${input_array[@]:1}"
        cstate="0" ;;

      exit)
        _exit_ 0 ;;
      "")

        echo -en ""
        cstate="0" ;;

      *)

        if [ "$cstate" -eq "1" ] ; then

          printf "stdout: %s\n" "unknown command"

        fi

      ;;

    esac

  done

  return $_STATE

}

###################################################
# Function Menu
###################################################

# Author of changes: trimstray (contact@nslab.at, https://github.com/trimstray)
#   - removed blank spaces/tabs
#   - correcting indentation (transparent code)
#   - replaced 'test' to '[[ ]]'
#   - changed comparison operator (-eq)
#   - protection against giving an illegal value
function menu() {

  clear
  echo -e $red ""
  echo "             80G08        "
  echo "                8G#G@8  "
  echo "                  8##0  "
  echo "                   0##G8    "
  echo "                     ####08 "
  echo "                      8#####8   "
  echo "                        G#####8   "
  echo "                         8G#####8   "
  echo "      #8#########0         #######8   "
  echo "          8#######0          0#88#####    "
  echo "            8G####8         8 8#8@@8###   "
  echo "               8###        G8   8@G######   "
  echo "                8##88       8     8######8    "
  echo "                  G##088          80G##G080   "
  echo "                    88000000008880#      000    "
  echo "                          9               0 "
  echo -e $okegreen"       .___                     _______                         ";
  echo "     __| _/___________    ____  \      \   _____ _____  ______  ";
  echo "    / __ |\_  __ \__  \ _/ ___\ /   |   \ /     \\__  \ \____  \ ";
  echo "   / /_/ | |  | \// __ \\  \___/     |    \  Y Y  \/ __ \|  |_> >";
  echo "   \____ | |__|  (____  /\___  >____|__  /__|_|  (____  /   __/ ";
  echo "        \/            \/     \/        \/      \/     \/|__|    ";
  echo ""
  echo -e $cyan"    Script by           $white":" $red Edo Maland ( Screetsec ) "
  echo -e $cyan"    Version             $white":" $red $Version  "
  echo -e $cyan"    Codename            $white":" $red $Codename "
  echo -e $cyan"    Follow me on Github $white":" $red @Screetsec "
  echo -e $cyan"    Dracos Linux        $white":" $red dracos-linux.org "
  echo -e $cyan ""
  echo -e $okegreen"    =========================================================    ";
  echo -e $white " "

  echo -e $white"     ID                    DESCRIPTION"
  echo -e $white"    ---------------------------------------------------------"
  echo -e $white"    [$okegreen"01"$white]$cyan  Regular scan"
  echo -e $white"    [$okegreen"02"$white]$cyan  Multiple scan"
  echo -e $white"    [$okegreen"03"$white]$cyan  OS detection and Trace"
  echo -e $white"    [$okegreen"04"$white]$cyan  Find out if a host is protected firewall"
  echo -e $white"    [$okegreen"05"$white]$cyan  Evading firewalls"
  echo -e $white"    [$okegreen"06"$white]$cyan  Ping Ping!!"
  echo -e $white"    [$okegreen"07"$white]$cyan  Web Applications"
  echo -e $white"    [$okegreen"08"$white]$cyan  Nmap Script Engine (NSE)"
  echo -e $white"    [$okegreen"09"$white]$cyan  Advanced Nmap scannings (Zenmap commands)"
  echo -e $white"    [$okegreen"10"$white]$cyan  Scanning target with output files"
  echo -e $white"    [$okegreen"11"$white]$cyan  Credits"
  echo -e " "

}

#######################################################
# CREDITS
#######################################################

# Author of changes: trimstray (contact@nslab.at, https://github.com/trimstray)
#   - removed blank spaces/tabs
#   - correcting indentation (transparent code)
function credits {

  clear
  echo -e "
  \033[31m##########################################################################\033[m
                  Credits To
  \033[31m##########################################################################\033[m"
  echo
  echo -e $white "Special thanks to:"
  echo
  echo -e $red "Dracos Linux ( www.dracos-linux.org )"
  echo
  echo -e $okegreen "Offensive Security for the awesome OS"
  echo
  echo -e $green "http://www.offensive-security.com/"
  echo
  echo -e $yellow "http://www.kali.org/"
  echo
  echo -e $cyan "http://www.kitploit.com/"
  echo
  echo -e $white "http://www.linuxsec.org/"
  echo
  echo -e $okegreen "My Friend for helpme ( Boy Suganda )"
  echo
  echo -e $red "Big Thanks to : http://www.github.com/"
  echo

  echo -en "Press key to back main menu"
  read _credits_key

  menu

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _exit_()
#
# Description:
#   Covers the default exit command.
#
# Usage:
#   _exit_ value
#
# Examples:
#   _exit_ 0
#

function _exit_() {

  clear
  sleep 1

  echo ""
  echo -e $yellow"[*] Thank You For Using Dracnmap  =)."
  echo ""
  echo -e $yellow"[*] Check Dracos Linux LFS, Penetration OS From Indonesia  =P."

  _STATUS="$1"
  exit "$_STATUS"

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_ip()
#
# Description:
#   Set the IP address.
#
# Usage:
#   _set_ip
#
# Examples:
#   _set_ip
#

function _set_ip() {

  local _FUNCTION_ID="_set_ip"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your IP Target or Host: " ; tput sgr0
  read -ra _ip

  if [[ $_ip =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] ; then

    _STATE=0

  else

    printf "stdout: %s\n" "invalid ip address"
    _STATE=1

  fi

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_port()
#
# Description:
#   Set the port number.
#
# Usage:
#   _set_port
#
# Examples:
#   _set_port
#

function _set_port() {

  local _FUNCTION_ID="_set_port"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your Port Target: " ; tput sgr0
  read -ra _port

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_user()
#
# Description:
#   Set the username.
#
# Usage:
#   _set_user
#
# Examples:
#   _set_user
#

function _set_user() {

  local _FUNCTION_ID="_set_user"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your cmd user: " ; tput sgr0
  read -ra _user

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_pass()
#
# Description:
#   Set the password.
#
# Usage:
#   _set_pass
#
# Examples:
#   _set_pass
#

function _set_pass() {

  local _FUNCTION_ID="_set_pass"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your cmd pass: " ; tput sgr0
  read -ra _pass

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_interface()
#
# Description:
#   Set the main network interface.
#
# Usage:
#   _set_interface
#
# Examples:
#   _set_interface
#

function _set_interface() {

  local _FUNCTION_ID="_set_interface"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your interface: " ; tput sgr0
  read -ra _iface

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_hwaddr()
#
# Description:
#   Set the mac address.
#
# Usage:
#   _set_hwaddr
#
# Examples:
#   _set_hwaddr
#

function _set_hwaddr() {

  local _FUNCTION_ID="_set_hwaddr"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your MAC address: " ; tput sgr0
  read -ra _hwaddr

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_domain()
#
# Description:
#   Set the domain.
#
# Usage:
#   _set_domain
#
# Examples:
#   _set_domain
#

function _set_domain() {

  local _FUNCTION_ID="_set_domain"
  local _STATE=0

  echo -en $cyan""
  echo -en "What is your domain name: " ; tput sgr0
  read -ra _domain

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_db_credentials()
#
# Description:
#   Set the database credentials.
#
# Usage:
#   _set_db_credentials
#
# Examples:
#   _set_db_credentials
#

function _set_db_credentials() {

  local _FUNCTION_ID="_set_db_credentials"
  local _STATE=0

  _set_user
  _userdb="$_user"

  _set_pass
  _passdb="$_pass"

  unset _user _pass

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _set_output()
#
# Description:
#   Set Nmap output.
#
# Usage:
#   _set_output
#
# Examples:
#   _set_output
#

function _set_output() {

  local _FUNCTION_ID="_set_output"
  local _STATE=0

  local _arg="$1"

  if [[ "$_arg" == "type" ]] ; then

    echo -en $cyan""
    echo -en "Type [*xml,html,normal,grep]: " ; tput sgr0
    read -ra _output_type

  elif [[ "$_arg" == "path" ]] ; then

    echo -en $cyan""
    echo -en "Path: " ; tput sgr0
    read -ra _output_path

  fi

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _help_()
#
# Description:
#   Help message.
#
# Usage:
#   _help_
#
# Examples:
#   _help_
#

function _help_() {

  local _FUNCTION_ID="_help_"
  local _STATE=0

  printf "%s" "
  Built-in:
    help                show this message
    show                show the builtin keys
    set                 set the builtin keys
    nmap                nmap command (full options)
    back                back to previous menu
    exit                exit from Dracnmap

  show/set:
    session             show session values

  show/set:session:
    ip                  new ip address
    port                new port number
    user                username
    pass                user password
    iface               interface
    hwaddr              hwaddr (MAC)
    domain              domain name
    dbuser              database user
    dbpass              database password
    outtype             output file type
    outpath             output file path

"

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: show_session()
#
# Description:
#   Show session configuration.
#
# Usage:
#   show_session
#
# Examples:
#   show_session
#

function show_session() {

  local _FUNCTION_ID="show_session"
  local _STATE=0

  for _svar in "${_session_variables[@]}" ; do

    _key_var=$(echo "$_svar" | awk -v FS="(:|:)" '{print $1}')
    _key_description=$(echo "$_svar" | awk -v FS="(:|:)" '{print $2}')
    _key_id=$(echo "$_svar" | awk -v FS="(:|:)" '{print $3}')

    _i="" ; eval _i='$'$_key_var

    # printf "%-8s %-8s %-8s [%-4s]\n" "_ip" "ip" "ip address" "127.0.0.1"
    if [[ -z "$_i" ]] ; then

      printf "{\"%s\"}:{\"%s\"}:{\"%s\"}\n" "$_key_id" "$_key_description" ""

    else

      printf "{\"%s\"}:{\"%s\"}:{\"%s\"}\n" "$_key_id" "$_key_description" "$_i"

    fi

  done

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: set_session()
#
# Description:
#   Set session configuration.
#
# Usage:
#   set_session
#
# Examples:
#   set_session
#

function set_session() {

  local _FUNCTION_ID="set_session"
  local _STATE=0

  local _session_arg="$1"

  case ${input_array[2]} in

    ip)
      _set_ip ;;
    port)
      _set_port ;;
    user)
      _set_user ;;
    pass)
      _set_pass ;;
    iface)
      _set_interface ;;
    hwaddr)
      _set_hwaddr ;;
    domain)
      _set_domain ;;
    db)
      _set_db_credentials ;;
    outtype)
      _set_output "type";;
    outpath)
      _set_output "path";;
    *)
      printf "stdout: %s\n" "unknown key" ;;

  esac

  return $_STATE

}

# ``````````````````````````````````````````````````````````````````````````````
# Function name: _init_cmd()
#
# Description:
#   Function executing given as a command parameter.
#
# Usage:
#   _init_cmd "parameter"
#
# Examples:
#   _init_cmd "eval cd /etc/init.d && ls"
#

function _init_cmd() {

  local _FUNCTION_ID="_init_cmd"
  local _STATE=0

  local _cmd="$@"

  printf "\nCommand:\n> \e[0;30m%s\e[m\n" "$_cmd"

  # Execute command and exit save to file.
  $_cmd ; _state="$?"

  if [[ "$_state" -eq 0 ]] ; then

    printf "\nResult: \e[0;32m%s\e[m\n\n" "pass"

  else

    printf "\nResult: \e[0;31m%s\e[m\n\n" "fail"

  fi

  _STATE=$_state

  return $_STATE

}
